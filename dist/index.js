'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _assign=require('babel-runtime/core-js/object/assign');var _assign2=_interopRequireDefault(_assign);var _extends=_assign2.default||function(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c){if(Object.prototype.hasOwnProperty.call(c,d)){a[d]=c[d]}}}return a};exports.setIn=setIn;exports.storeHelper=storeHelper;exports.connect=connect;exports.default=Store;var _emitter=require('./emitter');var _emitter2=_interopRequireDefault(_emitter);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var _ExternalPromiseCached;function _ExternalPromise(){if(_ExternalPromiseCached)return _ExternalPromiseCached;if(typeof window!=='undefined'&&window.Promise&&typeof window.Promise.resolve==='function'){_ExternalPromiseCached=window.Promise}else{_ExternalPromiseCached=require('babel-runtime/core-js/promise').default||require('babel-runtime/core-js/promise')}return _ExternalPromiseCached}var actionsCache={};var mutationsCache={};var storeInstance='';var emitter=new _emitter2.default;function logger(){return console.info.apply(this,arguments)}function isObject(a){return Object.prototype.toString.call(a)==='[object Object]'};function isString(a){return Object.prototype.toString.call(a)==='[object String]'};function setIn(a,b,c){var d=function setRecursively(a,b,c,e){var f={};var g=b[e];var h=void 0;if(b.length>e){if(Array.isArray(a)){f=a.slice(0)}else{f=(0,_assign2.default)({},a)}h=a[g]!==undefined?a[g]:{};f[g]=d(h,b,c,e+1);return f}return c};return d(a,b,c,0)}var innerMutation={_setIn:function _setIn(a,b){return setIn(a,b.path,b.value)}};function createHelpers(a,b){var c=(0,_assign2.default)({},mutationsCache,b,innerMutation);return{commit:function commit(a,b){if(!a){throw new Error('not found '+a+' action')}if(isObject(a)){b=a;a='update'}logger('%c prev state','color: #9E9E9E; font-weight: bold',this.data);logger('%c mutation: '+a,'color: #03A9F4; font-weight: bold',b,new Date().getTime());var d=c[a]?c[a](this.data,b):b;this.setData(d);emitter.emitEvent('updateState',_extends({},this.data));logger('%c next state','color: #4CAF50; font-weight: bold',this.data);return this.data},dispatch:function dispatch(b,c){var d=(0,_assign2.default)({},a,this);var e=d[b];if(!e){throw new Error('not found an action')}var f=this;logger('%c action '+b+' dispatching','color: #9E9E9E; font-weight: bold',c);var g=e.call(f,{commit:this.commit.bind(f),dispatch:this.dispatch.bind(f),put:function put(a){var b=d[a];if(!b){throw new Error('not found '+a+' action')}if(b){for(var c=arguments.length,e=Array(c>1?c-1:0),g=1;g<c;g++){e[g-1]=arguments[g]}b.apply(f,e)}},get state(){return f.data}},c);if(g instanceof _ExternalPromise()){return g}return _ExternalPromise().resolve(g)}}}function storeHelper(a,b,c){return _extends({},c,createHelpers.call(this,a,b))}function setDataByStateProps(a,b,c){if(Array.isArray(a)){var d=a.reduce(function(a,c){a[c]=b[c];return a},{});return d}else{var e=Object.keys(a).reduce(function(d,e){if(isString(a[e])){d[e]=b[a[e]]}else{d[e]=a[e](b,c)}return d},{});return e}}function connect(a){var b=a.mapStateToProps;return function(a){var c=a.didMount;(0,_assign2.default)(mutationsCache,a.mutations||{});return _extends({},a,{methods:_extends({},a.methods,createHelpers.call(this,actionsCache,mutationsCache)),didMount:function didMount(){var d=this;var e=setDataByStateProps(b,Store.getInstance.data,a);this.setData(e);if(b){emitter.addListener('updateState',function(){var c=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var e=setDataByStateProps(b,c,a);d.setData(e)})}if(typeof c==='function'){c.call(this)}}})}}function Store(a,b){var c=a.actions||a;var d=a.mutations||{};(0,_assign2.default)(actionsCache,c);(0,_assign2.default)(mutationsCache,d);var e=a.state||{};return function(a){a.data=a.data||{};(0,_assign2.default)(a.data,a.state);var b=a.onLoad;a.onLoad=function(){Store.getInstance=this;Object.defineProperty(this,'state',{get:function get(){return this.data}});if(b){b.apply(this,arguments)}};return storeHelper(c,d,a)}}